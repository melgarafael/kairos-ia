# ğŸ”„ Fluxogramas e Diagramas - Suporte Tomik CRM

VisualizaÃ§Ãµes de processos e arquitetura do sistema para facilitar compreensÃ£o e troubleshooting.

---

## ğŸ—ï¸ ARQUITETURA GERAL

### Diagrama Master-Client

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           MASTER SUPABASE                               â”‚
â”‚                      (SaaS Central - qckjiolragbvvpqvfhrj)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ saas_users   â”‚  â”‚ saas_organizations â”‚  â”‚ saas_plans    â”‚           â”‚
â”‚  â”‚              â”‚  â”‚                  â”‚  â”‚               â”‚             â”‚
â”‚  â”‚ â€¢ id         â”‚  â”‚ â€¢ id             â”‚  â”‚ â€¢ id          â”‚             â”‚
â”‚  â”‚ â€¢ email      â”‚  â”‚ â€¢ name           â”‚  â”‚ â€¢ name        â”‚             â”‚
â”‚  â”‚ â€¢ org_id â”€â”€â”€â”€â”¼â”€â†’â”‚ â€¢ owner_id       â”‚  â”‚ â€¢ slug        â”‚             â”‚
â”‚  â”‚              â”‚  â”‚ â€¢ plan_id â”€â”€â”€â”€â”€â”€â”€â”¼â”€â†’â”‚ â€¢ limits      â”‚             â”‚
â”‚  â”‚              â”‚  â”‚ â€¢ client_org_id  â”‚  â”‚ â€¢ features    â”‚             â”‚
â”‚  â”‚              â”‚  â”‚ â€¢ client_url     â”‚  â”‚               â”‚             â”‚
â”‚  â”‚              â”‚  â”‚ â€¢ client_anon    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚  â”‚              â”‚  â”‚ â€¢ client_service â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜                                â”‚
â”‚                                     â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ saas_plan_   â”‚  â”‚ saas_memberships â”‚  â”‚ saas_         â”‚             â”‚
â”‚  â”‚ tokens       â”‚  â”‚                  â”‚  â”‚ subscriptions â”‚             â”‚
â”‚  â”‚              â”‚  â”‚ â€¢ user_id        â”‚  â”‚               â”‚             â”‚
â”‚  â”‚ â€¢ owner_id   â”‚  â”‚ â€¢ org_id         â”‚  â”‚ â€¢ org_id      â”‚             â”‚
â”‚  â”‚ â€¢ plan_id    â”‚  â”‚ â€¢ role           â”‚  â”‚ â€¢ plan_id     â”‚             â”‚
â”‚  â”‚ â€¢ status     â”‚  â”‚ â€¢ status         â”‚  â”‚ â€¢ status      â”‚             â”‚
â”‚  â”‚ â€¢ applied_orgâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ automation_* (GestÃ£o de Clientes do Gestor)     â”‚                  â”‚
â”‚  â”‚ â€¢ automation_clients                             â”‚                  â”‚
â”‚  â”‚ â€¢ automation_contracts                           â”‚                  â”‚
â”‚  â”‚ â€¢ automation_processes                           â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ client_org_id mapping
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT SUPABASE                                 â”‚
â”‚                    (EspecÃ­fico da OrganizaÃ§Ã£o)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ saas_        â”‚  â”‚ users          â”‚  â”‚ patients/     â”‚               â”‚
â”‚  â”‚ organizationsâ”‚  â”‚                â”‚  â”‚ clients       â”‚               â”‚
â”‚  â”‚              â”‚  â”‚ â€¢ id           â”‚  â”‚               â”‚               â”‚
â”‚  â”‚ â€¢ id â—„â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¤ â€¢ org_id       â”‚  â”‚ â€¢ id          â”‚               â”‚
â”‚  â”‚ â€¢ name       â”‚  â”‚ â€¢ nome         â”‚  â”‚ â€¢ nome        â”‚               â”‚
â”‚  â”‚ â€¢ owner_id   â”‚  â”‚ â€¢ email        â”‚  â”‚ â€¢ org_id      â”‚               â”‚
â”‚  â”‚              â”‚  â”‚ â€¢ role         â”‚  â”‚               â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ appointments â”‚  â”‚ crm_leads      â”‚  â”‚ processes     â”‚               â”‚
â”‚  â”‚              â”‚  â”‚                â”‚  â”‚ (Kanban)      â”‚               â”‚
â”‚  â”‚ â€¢ id         â”‚  â”‚ â€¢ id           â”‚  â”‚               â”‚               â”‚
â”‚  â”‚ â€¢ patient_id â”‚  â”‚ â€¢ nome         â”‚  â”‚ â€¢ id          â”‚               â”‚
â”‚  â”‚ â€¢ org_id     â”‚  â”‚ â€¢ org_id       â”‚  â”‚ â€¢ client_id   â”‚               â”‚
â”‚  â”‚              â”‚  â”‚                â”‚  â”‚ â€¢ org_id      â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                         â”‚
â”‚                  ğŸ”’ RLS: Filtra por organization_id                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Pontos-chave**:
- **Master**: Gerencia usuÃ¡rios, organizaÃ§Ãµes, planos, autenticaÃ§Ã£o
- **Client**: Dados especÃ­ficos de cada organizaÃ§Ã£o (CRM)
- **Isolamento**: RLS garante que cada org sÃ³ vÃª seus dados
- **Mapping**: `client_org_id` conecta Master e Client

---

## ğŸ” FLUXO DE AUTENTICAÃ‡ÃƒO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USUÃRIO   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Login (email + senha)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MASTER SUPABASE     â”‚
â”‚  Auth Service        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Valida credenciais
       â”‚    Busca em saas_users
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gera JWT Token      â”‚
â”‚                      â”‚
â”‚  {                   â”‚
â”‚    user_id: "...",   â”‚
â”‚    email: "...",     â”‚
â”‚    organization_id: "..."  â”‚
â”‚  }                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. Retorna JWT
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FRONTEND (React)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                         â”‚
       â”‚ 4a. Acessa Master       â”‚ 4b. Acessa Client
       â†“                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Master API   â”‚         â”‚ Client API   â”‚
â”‚ + JWT Token  â”‚         â”‚ + JWT Token  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                         â”‚
       â”‚ 5a. Busca dados         â”‚ 5b. Busca dados
       â”‚     do usuÃ¡rio,         â”‚     do CRM
       â”‚     planos, tokens      â”‚     (patients, etc)
       â†“                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RLS: âœ…      â”‚         â”‚ RLS: âœ…      â”‚
â”‚ auth.uid()   â”‚         â”‚ org_id       â”‚
â”‚ = user_id    â”‚         â”‚ = JWT.org_id â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                         â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ 6. Retorna dados filtrados
                 â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  INTERFACE   â”‚
         â”‚   (React)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Pontos-chave**:
- JWT contÃ©m `user_id` e `organization_id`
- RLS usa `auth.uid()` para filtrar automaticamente
- Frontend faz chamadas paralelas (Master + Client)
- Isolamento total entre organizaÃ§Ãµes

---

## ğŸ« FLUXO DE APLICAÃ‡ÃƒO DE TOKEN

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Admin emite  â”‚
â”‚ Token        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Admin: issue_tokens (Edge Function)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ saas_plan_tokens                        â”‚
â”‚                                         â”‚
â”‚ â€¢ owner_user_id: USER_ID                â”‚
â”‚ â€¢ plan_id: PLAN_ID                      â”‚
â”‚ â€¢ status: "available"                   â”‚
â”‚ â€¢ valid_until: NOW + 30 days (mensal)  â”‚
â”‚ â€¢ is_frozen: false/true                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. UsuÃ¡rio vÃª tokens disponÃ­veis
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend    â”‚
â”‚  (React)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. UsuÃ¡rio clica "Aplicar Token"
       â”‚    Seleciona organizaÃ§Ã£o
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function: plan-tokens?action=applyâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. VerificaÃ§Ãµes
       â”œâ”€â†’ Token existe e Ã© do usuÃ¡rio? âœ…
       â”œâ”€â†’ Status = "available"? âœ…
       â”œâ”€â†’ NÃ£o expirado (se nÃ£o frozen)? âœ…
       â”œâ”€â†’ UsuÃ¡rio Ã© owner da org? âœ…
       â””â”€â†’ Todas OK? Continue â†“
       â”‚
       â”‚ 5. AplicaÃ§Ã£o
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Atualiza Token:                      â”‚
â”‚    â€¢ status: "redeemed"                 â”‚
â”‚    â€¢ applied_organization_id: ORG_ID    â”‚
â”‚    â€¢ applied_at: NOW                    â”‚
â”‚                                         â”‚
â”‚ 2. Atualiza OrganizaÃ§Ã£o:               â”‚
â”‚    â€¢ plan_id: TOKEN.plan_id            â”‚
â”‚    â€¢ Se frozen: valid_until = NOW + duration â”‚
â”‚                                         â”‚
â”‚ 3. Cria/Atualiza Subscription:         â”‚
â”‚    â€¢ organization_id: ORG_ID           â”‚
â”‚    â€¢ plan_id: TOKEN.plan_id            â”‚
â”‚    â€¢ status: "active"                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 6. Sucesso
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OrganizaÃ§Ã£o  â”‚
â”‚ atualizada!  â”‚
â”‚ âœ…           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Frozen Token Special Case**:
```
Token Normal:
  valid_until = PURCHASE_DATE + 30 days
  â†’ Conta desde a compra

Token Frozen:
  valid_until = null (atÃ© aplicar)
  â†’ Ao aplicar: valid_until = APPLICATION_DATE + 30 days
  â†’ Conta desde a aplicaÃ§Ã£o
```

---

## ğŸ”„ PROCESSO DE RESINCRONIZAÃ‡ÃƒO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Projeto      â”‚
â”‚ Deletado     â”‚
â”‚ âŒ          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. DiagnÃ³stico detecta projeto deletado
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OrganizationDiagnosticsModal            â”‚
â”‚                                          â”‚
â”‚ Status: âŒ Projeto Deletado              â”‚
â”‚ BotÃ£o: "Resincronizar OrganizaÃ§Ã£o"      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. UsuÃ¡rio clica "Resincronizar"
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OrganizationResyncModal                 â”‚
â”‚                                          â”‚
â”‚ âš ï¸ AVISOS:                              â”‚
â”‚ â€¢ Dados do CRM serÃ£o perdidos           â”‚
â”‚ â€¢ ConfiguraÃ§Ãµes serÃ£o perdidas          â”‚
â”‚ â€¢ Processo leva 2-5 minutos             â”‚
â”‚                                          â”‚
â”‚ BotÃ£o: "Confirmar ResincronizaÃ§Ã£o"      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. UsuÃ¡rio confirma
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function: provision-subscription (ou similar)              â”‚
â”‚                                                                 â”‚
â”‚ 1ï¸âƒ£ Criar novo projeto Supabase                                 â”‚
â”‚    â€¢ Via API do Supabase                                       â”‚
â”‚    â€¢ Aguardar provisionamento (30-60s)                         â”‚
â”‚    â€¢ Obter: project_ref, URL, anon_key, service_role          â”‚
â”‚                                                                 â”‚
â”‚ 2ï¸âƒ£ Importar schema completo                                    â”‚
â”‚    â€¢ Executar SQL de setup                                     â”‚
â”‚    â€¢ Criar tabelas base (saas_organizations, users, etc)       â”‚
â”‚    â€¢ Configurar RLS policies                                   â”‚
â”‚    â€¢ Criar funÃ§Ãµes e triggers                                  â”‚
â”‚                                                                 â”‚
â”‚ 3ï¸âƒ£ Criar registro da organizaÃ§Ã£o no Client                     â”‚
â”‚    â€¢ INSERT INTO saas_organizations                            â”‚
â”‚    â€¢ Usar mesmo ID (client_org_id)                             â”‚
â”‚    â€¢ Associar owner_id                                         â”‚
â”‚                                                                 â”‚
â”‚ 4ï¸âƒ£ Atualizar Master Supabase                                   â”‚
â”‚    â€¢ UPDATE saas_organizations SET:                            â”‚
â”‚      - client_org_id = NEW_ORG_ID                              â”‚
â”‚      - client_supabase_url = NEW_URL                           â”‚
â”‚      - client_anon_key_encrypted = BTOA(NEW_ANON)              â”‚
â”‚      - client_service_key_encrypted = BTOA(NEW_SERVICE)        â”‚
â”‚                                                                 â”‚
â”‚ 5ï¸âƒ£ Limpar cache e reconectar                                   â”‚
â”‚    â€¢ supabaseManager.clearAllConnections()                     â”‚
â”‚    â€¢ Disparar eventos de refresh                               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 6. ResincronizaÃ§Ã£o concluÃ­da
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend                                 â”‚
â”‚                                          â”‚
â”‚ 1. refreshUser() - atualiza dados       â”‚
â”‚ 2. window.location.reload() - recarrega â”‚
â”‚ 3. Reconecta com novo Client Supabase   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 7. UsuÃ¡rio acessa organizaÃ§Ã£o normalmente
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OrganizaÃ§Ã£o  â”‚
â”‚ Operacional  â”‚
â”‚ âœ… (VAZIO)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš ï¸ Pontos CrÃ­ticos**:
- **Dados perdidos**: CRM, configuraÃ§Ãµes, arquivos
- **Dados preservados**: Metadados da org (nome, plano)
- **Tempo**: 2-5 minutos
- **NÃ£o reversÃ­vel**: NÃ£o hÃ¡ backup dos dados antigos

---

## ğŸ” PIPELINE DE DIAGNÃ“STICO DE ORGANIZAÃ‡ÃƒO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UsuÃ¡rio      â”‚
â”‚ reporta erro â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Abre OrganizationDiagnosticsModal
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ runDiagnostics(org_id, user_id)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Busca dados no Master
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT * FROM saas_organizations                            â”‚
â”‚ WHERE id = org_id OR client_org_id = org_id                 â”‚
â”‚                                                             â”‚
â”‚ ObtÃ©m:                                                      â”‚
â”‚ â€¢ name, client_org_id                                       â”‚
â”‚ â€¢ client_supabase_url                                       â”‚
â”‚ â€¢ client_anon_key_encrypted                                 â”‚
â”‚ â€¢ owner_id                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                              â”‚
       â”‚ Check 0: Edge Function Access                â”‚
       â†“                                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚ POST saas-orgs          â”‚                          â”‚
â”‚ ?action=select          â”‚                          â”‚
â”‚                         â”‚                          â”‚
â”‚ â€¢ 403? â†’ Fail           â”‚                          â”‚
â”‚ â€¢ 200? â†’ Pass âœ…        â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
          â”‚                                          â”‚
          â”‚ Check 1: Project Status                  â”‚
          â†“                                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚ checkProjectStatus()    â”‚                          â”‚
â”‚                         â”‚                          â”‚
â”‚ 1. HEAD {url}/rest/v1/  â”‚                          â”‚
â”‚    â€¢ 404? â†’ Deleted     â”‚                          â”‚
â”‚    â€¢ 503? â†’ Paused      â”‚                          â”‚
â”‚    â€¢ Timeout? â†’ Check DNS â”‚                       â”‚
â”‚                         â”‚                          â”‚
â”‚ 2. Se timeout, DNS:     â”‚                          â”‚
â”‚    â€¢ NÃ£o resolve â†’ Deleted â”‚                      â”‚
â”‚    â€¢ Resolve â†’ Paused   â”‚                          â”‚
â”‚                         â”‚                          â”‚
â”‚ 3. Query Client:        â”‚                          â”‚
â”‚    SELECT FROM clients  â”‚                          â”‚
â”‚    â€¢ Error? â†’ Inactive  â”‚                          â”‚
â”‚    â€¢ OK? â†’ Active âœ…    â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
          â”‚                                          â”‚
          â”‚ Check 2: DNS                             â”‚
          â†“                                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚ checkDNS()              â”‚                          â”‚
â”‚                         â”‚                          â”‚
â”‚ fetch(hostname)         â”‚                          â”‚
â”‚ â€¢ Resolve? â†’ Pass âœ…    â”‚                          â”‚
â”‚ â€¢ NXDOMAIN? â†’ Fail âŒ   â”‚                          â”‚
â”‚ â€¢ Timeout? â†’ Fail âŒ    â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
          â”‚                                          â”‚
          â”‚ Check 3: Master-Client Sync              â”‚
          â†“                                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚ checkMasterClientSync() â”‚                          â”‚
â”‚                         â”‚                          â”‚
â”‚ 1. Master:              â”‚                          â”‚
â”‚    client_org_id exists? â”‚                        â”‚
â”‚    â€¢ Null? â†’ Fail âŒ    â”‚                          â”‚
â”‚                         â”‚                          â”‚
â”‚ 2. Client:              â”‚                          â”‚
â”‚    SELECT FROM          â”‚                          â”‚
â”‚    saas_organizations   â”‚                          â”‚
â”‚    WHERE id = client_org_id â”‚                     â”‚
â”‚    â€¢ Not found? â†’ Fail âŒâ”‚                         â”‚
â”‚    â€¢ Found? â†’ Pass âœ…   â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
          â”‚                                          â”‚
          â”‚ Check 4: Ownership                       â”‚
          â†“                                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚ checkOwnership()        â”‚                          â”‚
â”‚                         â”‚                          â”‚
â”‚ If isMembership:        â”‚                          â”‚
â”‚   SELECT FROM           â”‚                          â”‚
â”‚   saas_memberships      â”‚                          â”‚
â”‚   WHERE user_id = X     â”‚                          â”‚
â”‚   AND org_id = Y        â”‚                          â”‚
â”‚   â€¢ Found? â†’ Pass âœ…    â”‚                          â”‚
â”‚   â€¢ Not found? â†’ Fail âŒâ”‚                          â”‚
â”‚                         â”‚                          â”‚
â”‚ Else (ownership):       â”‚                          â”‚
â”‚   org.owner_id == user_id? â”‚                      â”‚
â”‚   â€¢ Yes? â†’ Pass âœ…      â”‚                          â”‚
â”‚   â€¢ No? â†’ Fail âŒ       â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
          â”‚                                          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ 5. Agregar resultados
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Determine overallStatus:                                    â”‚
â”‚                                                             â”‚
â”‚ â€¢ hasPaused? â†’ "paused" â¸                                  â”‚
â”‚ â€¢ hasFailures? â†’ "error" âŒ                                â”‚
â”‚ â€¢ hasWarnings? â†’ "warning" âš ï¸                              â”‚
â”‚ â€¢ allPass? â†’ "healthy" âœ…                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 6. Exibir no modal
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OrganizationDiagnosticsModal     â”‚
â”‚                                  â”‚
â”‚ Status Geral: [STATUS]           â”‚
â”‚                                  â”‚
â”‚ VerificaÃ§Ãµes:                    â”‚
â”‚ âœ…/âŒ Edge Function Access       â”‚
â”‚ âœ…/âŒ/â¸ Project Status           â”‚
â”‚ âœ…/âŒ DNS                         â”‚
â”‚ âœ…/âŒ Master-Client Sync          â”‚
â”‚ âœ…/âŒ Ownership                   â”‚
â”‚                                  â”‚
â”‚ [BotÃµes de AÃ§Ã£o]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ FLUXO SUPABASE AUTO UPDATER

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UsuÃ¡rio     â”‚
â”‚  acessa app  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Componente SupabaseAutoUpdater renderiza
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useEffect: Auto-preencher Service Role e Project Ref       â”‚
â”‚                                                             â”‚
â”‚ 1. Busca em saas_organizations (prioridade):               â”‚
â”‚    â€¢ client_service_key_encrypted â†’ decrypt â†’ setServiceRole â”‚
â”‚    â€¢ client_supabase_url â†’ extract ref â†’ setProjectRef     â”‚
â”‚    â€¢ client_anon_key_encrypted â†’ decrypt â†’ setClientAnonKey â”‚
â”‚                                                             â”‚
â”‚ 2. Fallback em saas_users:                                 â”‚
â”‚    â€¢ service_role_encrypted â†’ decrypt â†’ setServiceRole     â”‚
â”‚    â€¢ supabase_url â†’ extract ref â†’ setProjectRef            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                                       â”‚
       â”‚ PASSO 1: Verificar Service Role Key                  â”‚
       â†“                                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚ checkStep1()            â”‚                                   â”‚
â”‚                         â”‚                                   â”‚
â”‚ Verifica em 3 locais:   â”‚                                   â”‚
â”‚ 1. saas_organizations.  â”‚                                   â”‚
â”‚    client_service_key_  â”‚                                   â”‚
â”‚    encrypted            â”‚                                   â”‚
â”‚ 2. saas_supabases_      â”‚                                   â”‚
â”‚    connections.         â”‚                                   â”‚
â”‚    service_role_encryptedâ”‚                                  â”‚
â”‚ 3. saas_users.          â”‚                                   â”‚
â”‚    service_role_encryptedâ”‚                                  â”‚
â”‚                         â”‚                                   â”‚
â”‚ â€¢ Found? â†’ âœ“ Configuradoâ”‚                                   â”‚
â”‚ â€¢ Not found? â†’ âš  Pendenteâ”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
          â”‚                                                   â”‚
          â”‚ PASSO 2: Verificar Edge Function                 â”‚
          â†“                                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚ checkStep3()            â”‚                                   â”‚
â”‚                         â”‚                                   â”‚
â”‚ POST {endpoint}         â”‚                                   â”‚
â”‚ action: "status_public" â”‚                                   â”‚
â”‚                         â”‚                                   â”‚
â”‚ â€¢ 200? â†’ FunÃ§Ã£o existe  â”‚                                   â”‚
â”‚   â†’ Verifica cÃ³digo:    â”‚                                   â”‚
â”‚   â†’ action: "get_code"  â”‚                                   â”‚
â”‚   â†’ Compara com local   â”‚                                   â”‚
â”‚   â†’ Igual? âœ“ Configuradoâ”‚                                   â”‚
â”‚   â†’ Diferente? âš  Desatualizado â”‚                           â”‚
â”‚                         â”‚                                   â”‚
â”‚ â€¢ 404? â†’ âš  Pendente     â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
          â”‚                                                   â”‚
          â”‚ PASSO 3: Verificar DATABASE_URL                  â”‚
          â†“                                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚ checkStep2()            â”‚                                   â”‚
â”‚                         â”‚                                   â”‚
â”‚ POST {endpoint}         â”‚                                   â”‚
â”‚ action: "status"        â”‚                                   â”‚
â”‚                         â”‚                                   â”‚
â”‚ Response:               â”‚                                   â”‚
â”‚ {                       â”‚                                   â”‚
â”‚   dbConfigured: bool,   â”‚                                   â”‚
â”‚   dbConnectable: bool,  â”‚                                   â”‚
â”‚   connectionError: str, â”‚                                   â”‚
â”‚   errorType: str        â”‚                                   â”‚
â”‚ }                       â”‚                                   â”‚
â”‚                         â”‚                                   â”‚
â”‚ â€¢ dbConfigured && dbConnectable? â”‚                         â”‚
â”‚   â†’ âœ“ Configurado       â”‚                                   â”‚
â”‚                         â”‚                                   â”‚
â”‚ â€¢ dbConfigured && !dbConnectable? â”‚                        â”‚
â”‚   â†’ âš  Erro! (senha?)   â”‚                                   â”‚
â”‚   â†’ errorType: "auth"   â”‚                                   â”‚
â”‚   â†’ DiagnÃ³stico detalhadoâ”‚                                  â”‚
â”‚                         â”‚                                   â”‚
â”‚ â€¢ !dbConfigured?        â”‚                                   â”‚
â”‚   â†’ âš  Pendente          â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
          â”‚                                                   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ 2. UsuÃ¡rio clica "Planejar atualizaÃ§Ãµes"
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ planUpdates()                                               â”‚
â”‚                                                             â”‚
â”‚ POST {endpoint}                                             â”‚
â”‚ {                                                           â”‚
â”‚   action: "plan",                                           â”‚
â”‚   manifest: [...migraÃ§Ãµes...]                               â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â”‚ Response:                                                   â”‚
â”‚ {                                                           â”‚
â”‚   ok: true,                                                 â”‚
â”‚   currentVersion: "v67",                                    â”‚
â”‚   totalMigrations: 150,                                     â”‚
â”‚   pendingCount: 5,                                          â”‚
â”‚   pending: [                                                â”‚
â”‚     {id: "20251110...", name: "..."},                       â”‚
â”‚     ...                                                     â”‚
â”‚   ]                                                         â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. Mostra lista de pendentes
       â”‚    UsuÃ¡rio clica "Aplicar pendentes"
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ applyUpdates()                                              â”‚
â”‚                                                             â”‚
â”‚ POST {endpoint}                                             â”‚
â”‚ {                                                           â”‚
â”‚   action: "apply",                                          â”‚
â”‚   manifest: [...migraÃ§Ãµes...]                               â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â”‚ Edge Function faz:                                          â”‚
â”‚ 1. Acquire lock (pg_advisory_lock)                          â”‚
â”‚ 2. Para cada migraÃ§Ã£o pendente:                             â”‚
â”‚    a. BEGIN transaction                                     â”‚
â”‚    b. SET statement_timeout = '300s'                        â”‚
â”‚    c. Executa SQL (sem BEGIN/COMMIT externo)                â”‚
â”‚    d. INSERT INTO tomikcrm_schema_migrations                â”‚
â”‚    e. COMMIT                                                â”‚
â”‚    f. Se erro: ROLLBACK e para                              â”‚
â”‚ 3. Release lock                                             â”‚
â”‚                                                             â”‚
â”‚ Response:                                                   â”‚
â”‚ {                                                           â”‚
â”‚   ok: true,                                                 â”‚
â”‚   steps: [                                                  â”‚
â”‚     {id: "...", name: "...", status: "success"},           â”‚
â”‚     {id: "...", name: "...", status: "error", error: "..."} â”‚
â”‚   ]                                                         â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. Mostra resultado
       â”‚    Replaneja para ver estado final
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Migrations   â”‚
â”‚ aplicadas!   â”‚
â”‚ âœ…          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Erros Comuns**:

```
âŒ "Missing bearer token"
   â†’ Passo 1 nÃ£o configurado
   â†’ SoluÃ§Ã£o: Salvar Service Role Key

âŒ "function not found" / 404
   â†’ Passo 2 nÃ£o configurado
   â†’ SoluÃ§Ã£o: Criar Edge Function

âŒ "Missing SUPABASE_DB_URL"
   â†’ Passo 3 nÃ£o configurado
   â†’ SoluÃ§Ã£o: Configurar DATABASE_URL secret

âŒ "Unknown response for startup: N"
   â†’ Passo 3 com senha incorreta
   â†’ SoluÃ§Ã£o: Resetar senha + encoding correto

âŒ "lock busy"
   â†’ Outra migraÃ§Ã£o em andamento
   â†’ SoluÃ§Ã£o: Aguardar ou desbloquear
```

---

## ğŸ¯ TROUBLESHOOTING DECISION TREE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UsuÃ¡rio reporta problema       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                                                     â”‚
            â”‚ Problema de ACESSO?                                 â”‚
            â†“                                                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
    â”‚ NÃ£o consegue  â”‚                                            â”‚
    â”‚ acessar org   â”‚                                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
            â”‚                                                     â”‚
            â”œâ”€â†’ Erro 403/401?                                    â”‚
            â”‚   â†’ Verificar autenticaÃ§Ã£o                          â”‚
            â”‚   â†’ Verificar ownership/membership                  â”‚
            â”‚   â†’ Verificar Edge Function access                  â”‚
            â”‚                                                     â”‚
            â”œâ”€â†’ Erro 404?                                        â”‚
            â”‚   â†’ Projeto deletado                                â”‚
            â”‚   â†’ OrganizationDiagnostics                         â”‚
            â”‚   â†’ Resincronizar                                   â”‚
            â”‚                                                     â”‚
            â”œâ”€â†’ Timeout/Sem resposta?                            â”‚
            â”‚   â†’ Projeto pausado                                 â”‚
            â”‚   â†’ Retomar no Supabase Dashboard                   â”‚
            â”‚                                                     â”‚
            â”œâ”€â†’ RLS error (42501)?                               â”‚
            â”‚   â†’ Verificar organization_id                       â”‚
            â”‚   â†’ Completar onboarding                            â”‚
            â”‚   â†’ Adicionar membership                            â”‚
            â”‚                                                     â”‚
            â””â”€â†’ Outro erro?                                      â”‚
                â†’ Executar OrganizationDiagnostics               â”‚
                â†’ Ver detalhes das 5 verificaÃ§Ãµes                â”‚
                                                                 â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ Problema de ATUALIZAÃ‡ÃƒO?
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SupabaseAuto  â”‚
    â”‚ Updater erro  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”œâ”€â†’ Passo 1 "âš  Pendente"?
            â”‚   â†’ Configurar Service Role Key
            â”‚   â†’ Supabase â†’ Settings â†’ API
            â”‚   â†’ Copiar service_role (nÃ£o anon!)
            â”‚   â†’ Tomik â†’ Salvar
            â”‚
            â”œâ”€â†’ Passo 2 "âš  Pendente"?
            â”‚   â†’ Criar Edge Function
            â”‚   â†’ Nome: client-schema-updater
            â”‚   â†’ CÃ³digo: copiar do Tomik
            â”‚   â†’ Deploy no Supabase
            â”‚
            â”œâ”€â†’ Passo 2 "âš  Desatualizado"?
            â”‚   â†’ Redeploy Edge Function
            â”‚   â†’ CÃ³digo atualizado do Tomik
            â”‚
            â”œâ”€â†’ Passo 3 "âš  Pendente"?
            â”‚   â†’ Configurar DATABASE_URL
            â”‚   â†’ Digitar senha no Tomik
            â”‚   â†’ Copiar DATABASE_URL gerada
            â”‚   â†’ Supabase â†’ Secrets â†’ Salvar
            â”‚
            â”œâ”€â†’ Passo 3 "âš  Erro!"?
            â”‚   â†’ Clique no badge para ver diagnÃ³stico
            â”‚   â†’ Senha incorreta? â†’ Reset + encoding
            â”‚   â†’ Ver mensagem de erro especÃ­fica
            â”‚   â†’ Caracteres especiais? â†’ URL encoding
            â”‚
            â”œâ”€â†’ "Lock busy"?
            â”‚   â†’ Aguardar 5 minutos
            â”‚   â†’ Ou desbloquear: pg_advisory_unlock
            â”‚
            â””â”€â†’ "saas_organizations not found"?
                â†’ SQL inicial nÃ£o importado
                â†’ Importar schema base no Supabase
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                                                    â”‚
            â”‚ Problema de DADOS/SCHEMA?                          â”‚
            â†“                                                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
    â”‚ Tabela nÃ£o    â”‚                                           â”‚
    â”‚ encontrada    â”‚                                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
            â”‚                                                    â”‚
            â””â”€â†’ "relation does not exist" (42P01)               â”‚
                â†’ Schema desatualizado                          â”‚
                â†’ SupabaseAutoUpdater â†’ Planejar â†’ Aplicar      â”‚
                                                                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
    â”‚ RLS bloqueandoâ”‚                                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
            â”‚                                                    â”‚
            â””â”€â†’ "row-level security" (42501)                    â”‚
                â†’ Verificar organization_id do usuÃ¡rio          â”‚
                â†’ Completar onboarding se NULL                  â”‚
                â†’ Adicionar membership se legÃ­timo              â”‚
                                                                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
    â”‚ Quota excedidaâ”‚                                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
            â”‚                                                    â”‚
            â””â”€â†’ "quota exceeded"                                â”‚
                â†’ Limite do plano Supabase                      â”‚
                â†’ Verificar: Settings â†’ Billing â†’ Usage         â”‚
                â†’ Upgrade para Supabase Pro                     â”‚
                â†’ Ou limpar dados antigos                       â”‚
                                                                â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ Problema de PLANO/TOKEN?
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Token nÃ£o     â”‚
    â”‚ aplica        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”œâ”€â†’ "Token not available"?
            â”‚   â†’ JÃ¡ foi aplicado (status = redeemed)
            â”‚   â†’ Ou expirado
            â”‚   â†’ Ou cancelado
            â”‚
            â”œâ”€â†’ "Token expired"?
            â”‚   â†’ valid_until < now
            â”‚   â†’ Verificar se Ã© frozen (sÃ³ conta apÃ³s aplicar)
            â”‚
            â”œâ”€â†’ "Organization not found"?
            â”‚   â†’ Org nÃ£o existe ou foi deletada
            â”‚   â†’ Verificar org_id correto
            â”‚
            â””â”€â†’ "Forbidden"?
                â†’ UsuÃ¡rio nÃ£o Ã© owner da org
                â†’ Verificar ownership
                
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Add-on nÃ£o    â”‚
    â”‚ funciona      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”œâ”€â†’ OrganizaÃ§Ãµes extra:
            â”‚   â†’ Verificar org_extra_count
            â”‚   â†’ Verificar subscription do add-on
            â”‚
            â””â”€â†’ Assentos extra:
                â†’ Verificar member_seats_extra
                â†’ Verificar saas_member_seats_grants
                â†’ Verificar validade (valid_until)
```

---

*Ãšltima atualizaÃ§Ã£o: 2025-11-13*
*VersÃ£o: 1.0*


